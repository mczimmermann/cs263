# ===============================
# Stage 1: Build Rust uutils coreutils (split)
# ===============================
FROM rust:latest AS rust-build

RUN apt-get update && apt-get install -y \
    git cmake build-essential wget libbenchmark-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src

# Clone the Rust coreutils repository
RUN git clone https://github.com/uutils/coreutils.git
WORKDIR /usr/src/coreutils

# Create a standalone benchmark crate
RUN mkdir -p date-bench/src date-bench/benches
WORKDIR /usr/src/coreutils/date-bench

# Create minimal lib file
RUN echo "// placeholder lib file\npub fn dummy() {}" > src/lib.rs

# Create Cargo.toml for the benchmark crate with empty workspace
RUN printf '[package]\nname = "date-bench"\nversion = "0.1.0"\nedition = "2021"\n\n[workspace]\n\n[dependencies]\nuu_date = { path = "../src/uu/date" }\nuucore = { path = "../src/uucore" }\ncriterion = "0.5"\ntempfile = "3"\nclap = { version = "4.4", features = ["wrap_help", "cargo"] }\n\n[[bench]]\nname = "date_bench"\nharness = false\n' > Cargo.toml

# Copy the benchmark source
COPY benches/date_bench.rs benches/date_bench.rs

# Build benchmark without running
RUN cargo bench --no-run

# Run Rust date benchmark and save results (save both stdout and stderr)
RUN cargo bench 2>&1 | tee /tmp/rust_date_bench.txt || echo "Rust benchmark failed with exit code $?" | tee -a /tmp/rust_date_bench.txt


# ===============================
# Stage 2: Build GNU coreutils 
# ===============================
# Stage 1: Download config files in modern Ubuntu
FROM ubuntu:22.04 AS config-downloader

RUN apt-get update && apt-get install -y wget && rm -rf /var/lib/apt/lists/*

WORKDIR /tmp
RUN wget -O config.guess 'https://raw.githubusercontent.com/gcc-mirror/gcc/master/config.guess' && \
    wget -O config.sub 'https://raw.githubusercontent.com/gcc-mirror/gcc/master/config.sub' && \
    chmod +x config.guess config.sub

# Stage 2: Build GNU coreutils and Google Benchmark in Ubuntu 14.04
FROM ubuntu:14.04 AS gnu-build

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    wget build-essential cmake autoconf automake \
    gettext autopoint bison git gperf texinfo rsync \
    vim nano strace libgtest-dev software-properties-common \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src

# Copy config files from modern environment
COPY --from=config-downloader /tmp/config.guess /tmp/config.guess
COPY --from=config-downloader /tmp/config.sub /tmp/config.sub

# Install GCC 5 first
RUN add-apt-repository ppa:ubuntu-toolchain-r/test && \
    apt-get update && \
    apt-get install -y g++-5 gcc-5 && \
    rm -rf /var/lib/apt/lists/*

# Update alternatives to use gcc-5 and g++-5
RUN update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 100 && \
    update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 100

# Install newer CMake (3.10) manually
WORKDIR /tmp
RUN wget https://cmake.org/files/v3.10/cmake-3.10.0-Linux-x86_64.tar.gz && \
    tar -xzf cmake-3.10.0-Linux-x86_64.tar.gz && \
    rm -rf /usr/local/man && \
    cp -r cmake-3.10.0-Linux-x86_64/* /usr/local/ && \
    rm -rf cmake-3.10.0-Linux-x86_64*

WORKDIR /usr/src

# Build Google Benchmark with GCC 5
RUN git clone https://github.com/google/benchmark.git && \
    cd benchmark && \
    git checkout v1.5.0
WORKDIR /usr/src/benchmark
RUN mkdir build && cd build && \
    cmake -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_COMPILER=g++-5 \
          -DCMAKE_C_COMPILER=gcc-5 \
          -DBENCHMARK_ENABLE_TESTING=OFF \
          .. && \
    make && \
    make install

WORKDIR /usr/src

# Install older automake (1.11.1) - the last version before stricter checks
RUN wget http://ftp.gnu.org/gnu/automake/automake-1.11.1.tar.gz && \
    tar -xzf automake-1.11.1.tar.gz && \
    cd automake-1.11.1 && \
    cp /tmp/config.guess config.guess && \
    cp /tmp/config.sub config.sub && \
    chmod +x config.guess config.sub && \
    cp /tmp/config.guess lib/config.guess && \
    cp /tmp/config.sub lib/config.sub && \
    chmod +x lib/config.guess lib/config.sub && \
    ./configure --prefix=/usr/local && \
    make && \
    make install && \
    cd .. && \
    rm -rf automake-1.11.1* && \
    mkdir -p /usr/local/share/aclocal

# Use GitHub mirrors instead of git.savannah.gnu.org
RUN git clone https://github.com/coreutils/gnulib.git
RUN git clone https://github.com/coreutils/coreutils.git && \
    cd coreutils && \
    git checkout 70d023b076ab82ad000a404310bc0aee2fa3ac80

WORKDIR /usr/src/coreutils

# Update config scripts for ARM64 support BEFORE bootstrap
RUN cp /tmp/config.guess build-aux/config.guess && \
    cp /tmp/config.sub build-aux/config.sub && \
    chmod +x build-aux/config.guess build-aux/config.sub

RUN ./bootstrap

# Update config scripts AGAIN after bootstrap (bootstrap may overwrite them)
RUN cp /tmp/config.guess build-aux/config.guess && \
    cp /tmp/config.sub build-aux/config.sub && \
    chmod +x build-aux/config.guess build-aux/config.sub

RUN FORCE_UNSAFE_CONFIGURE=1 ./configure

# Build only the source and library, skip docs
RUN make -j$(nproc) -C lib
RUN make -j$(nproc) -C src

# Extract the actual compilation flags used
RUN cd src && make date.o V=1 2>&1 | tee /tmp/compile_flags.txt || true

# Now copy modified date.c
COPY date.c /usr/src/coreutils/src/date.c

# Rebuild date.o manually with proper flags
RUN cd src && \
    gcc -DHAVE_CONFIG_H \
    -I. -I.. -I../lib -I../lib \
    -DLOCALEDIR=\"/usr/local/share/locale\" \
    -g -O2 -c date.c -o date.o

RUN cd src && gcc -DHAVE_CONFIG_H \
    -I. -I.. -I../lib -I../lib \
    -g -O2 -c version.c -o version.o

# Copy benchmark
COPY date_benchmark.cpp /usr/src/

# Compile benchmark and link with date.o and all coreutils dependencies
WORKDIR /usr/src
RUN g++ -std=c++11 -O3 date_benchmark.cpp \
    /usr/src/coreutils/src/date.o \
    /usr/src/coreutils/src/version.o \
    /usr/src/coreutils/lib/libcoreutils.a \
    -o gnu_date_benchmark \
    -Wl,--whole-archive -lbenchmark -Wl,--no-whole-archive -lpthread \
    -I/usr/src/coreutils \
    -I/usr/src/coreutils/src \
    -I/usr/src/coreutils/lib

RUN ./gnu_date_benchmark --benchmark_format=console 2>&1 | tee /tmp/gnu_date_bench.txt || echo "GNU benchmark failed" | tee -a /tmp/gnu_date_bench.txt

# ===============================
# Stage 3: Combine results
# ===============================
FROM ubuntu:22.04

WORKDIR /results
COPY --from=rust-build /tmp/rust_date_bench.txt rust_date_bench.txt
COPY --from=gnu-build /tmp/gnu_date_bench.txt gnu_date_bench.txt

RUN echo "=== RUST DATE BENCHMARK ===" > bench_results.txt && \
    cat rust_date_bench.txt >> bench_results.txt && \
    echo "" >> bench_results.txt && \
    echo "=== GNU DATE BENCHMARK ===" >> bench_results.txt && \
    cat gnu_date_bench.txt >> bench_results.txt

CMD ["cat", "/results/bench_results.txt"]