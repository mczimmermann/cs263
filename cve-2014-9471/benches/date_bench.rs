use criterion::{criterion_group, criterion_main, Criterion};
use std::process::Command;
use std::fs::File;
use std::time::Instant;

// Helper function to execute date command and measure time
fn execute_date(args: &[&str]) -> Result<std::time::Duration, String> {
    let start = Instant::now();
    
    let output = Command::new("date")
        .args(args)
        .output()
        .map_err(|e| format!("Failed to execute date: {}", e))?;
    
    let duration = start.elapsed();
    
    if !output.status.success() {
        return Err(format!("date command failed with status: {}", output.status));
    }
    
    Ok(duration)
}

// Benchmark: Simple date display (default format)
fn bench_date_default(c: &mut Criterion) {
    c.bench_function("date_default", |b| {
        b.iter_custom(|iters| {
            let mut total = std::time::Duration::ZERO;
            for _i in 0..iters {
                match execute_date(&[]) {
                    Ok(duration) => total += duration,
                    Err(e) => panic!("Benchmark failed: {}", e),
                }
            }
            total
        });
    });
}

// Benchmark: ISO 8601 format
fn bench_date_iso8601(c: &mut Criterion) {
    c.bench_function("date_iso8601", |b| {
        b.iter_custom(|iters| {
            let mut total = std::time::Duration::ZERO;
            for _i in 0..iters {
                match execute_date(&["--iso-8601=seconds"]) {
                    Ok(duration) => total += duration,
                    Err(e) => panic!("Benchmark failed: {}", e),
                }
            }
            total
        });
    });
}

// Benchmark: RFC 2822 format
fn bench_date_rfc2822(c: &mut Criterion) {
    c.bench_function("date_rfc2822", |b| {
        b.iter_custom(|iters| {
            let mut total = std::time::Duration::ZERO;
            for _i in 0..iters {
                match execute_date(&["--rfc-2822"]) {
                    Ok(duration) => total += duration,
                    Err(e) => panic!("Benchmark failed: {}", e),
                }
            }
            total
        });
    });
}

// Benchmark: Custom format with multiple components
fn bench_date_custom_format(c: &mut Criterion) {
    c.bench_function("date_custom_format", |b| {
        b.iter_custom(|iters| {
            let mut total = std::time::Duration::ZERO;
            for _i in 0..iters {
                match execute_date(&["+%Y-%m-%d %H:%M:%S.%N %z"]) {
                    Ok(duration) => total += duration,
                    Err(e) => panic!("Benchmark failed: {}", e),
                }
            }
            total
        });
    });
}

// Benchmark: Unix timestamp output
fn bench_date_unix_timestamp(c: &mut Criterion) {
    c.bench_function("date_unix_timestamp", |b| {
        b.iter_custom(|iters| {
            let mut total = std::time::Duration::ZERO;
            for _i in 0..iters {
                match execute_date(&["+%s"]) {
                    Ok(duration) => total += duration,
                    Err(e) => panic!("Benchmark failed: {}", e),
                }
            }
            total
        });
    });
}

// Benchmark: Parse and display date string
fn bench_date_parse(c: &mut Criterion) {
    c.bench_function("date_parse", |b| {
        b.iter_custom(|iters| {
            let mut total = std::time::Duration::ZERO;
            for _i in 0..iters {
                match execute_date(&["-d", "2024-01-15 14:30:00"]) {
                    Ok(duration) => total += duration,
                    Err(e) => panic!("Benchmark failed: {}", e),
                }
            }
            total
        });
    });
}

// Benchmark: Parse relative date
fn bench_date_relative(c: &mut Criterion) {
    c.bench_function("date_relative", |b| {
        b.iter_custom(|iters| {
            let mut total = std::time::Duration::ZERO;
            for _i in 0..iters {
                match execute_date(&["-d", "tomorrow"]) {
                    Ok(duration) => total += duration,
                    Err(e) => panic!("Benchmark failed: {}", e),
                }
            }
            total
        });
    });
}

// Benchmark: Parse complex relative date
fn bench_date_complex_relative(c: &mut Criterion) {
    c.bench_function("date_complex_relative", |b| {
        b.iter_custom(|iters| {
            let mut total = std::time::Duration::ZERO;
            for _i in 0..iters {
                match execute_date(&["-d", "3 days 2 hours 15 minutes ago"]) {
                    Ok(duration) => total += duration,
                    Err(e) => panic!("Benchmark failed: {}", e),
                }
            }
            total
        });
    });
}

// Benchmark: UTC conversion
fn bench_date_utc(c: &mut Criterion) {
    c.bench_function("date_utc", |b| {
        b.iter_custom(|iters| {
            let mut total = std::time::Duration::ZERO;
            for _i in 0..iters {
                match execute_date(&["-u"]) {
                    Ok(duration) => total += duration,
                    Err(e) => panic!("Benchmark failed: {}", e),
                }
            }
            total
        });
    });
}

// Benchmark: Reference file timestamp
fn bench_date_reference(c: &mut Criterion) {
    // Create a temporary reference file
    let ref_file = "/tmp/date_bench_ref_rust";
    File::create(ref_file).expect("Failed to create reference file");
    
    c.bench_function("date_reference", |b| {
        b.iter_custom(|iters| {
            let mut total = std::time::Duration::ZERO;
            for _i in 0..iters {
                match execute_date(&["-r", ref_file]) {
                    Ok(duration) => total += duration,
                    Err(e) => {
                        std::fs::remove_file(ref_file).ok();
                        panic!("Benchmark failed: {}", e)
                    },
                }
            }
            total
        });
    });
    
    // Cleanup
    std::fs::remove_file(ref_file).ok();
}

criterion_group!(
    benches,
    bench_date_default,
    bench_date_iso8601,
    bench_date_rfc2822,
    bench_date_custom_format,
    bench_date_unix_timestamp,
    bench_date_parse,
    bench_date_relative,
    bench_date_complex_relative,
    bench_date_utc,
    bench_date_reference
);

criterion_main!(benches);