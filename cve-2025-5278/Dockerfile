# ===============================
# Stage 1: Build Rust uutils coreutils (split)
# ===============================
FROM rust:latest AS rust-build

RUN apt-get update && apt-get install -y \
    git cmake build-essential wget libbenchmark-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src

# Clone the Rust coreutils repository
RUN git clone https://github.com/uutils/coreutils.git
WORKDIR /usr/src/coreutils

# Create a standalone benchmark crate
RUN mkdir -p sort-bench/src sort-bench/benches
WORKDIR /usr/src/coreutils/sort-bench

# Create minimal lib file
RUN echo "// placeholder lib file\npub fn dummy() {}" > src/lib.rs

# Create Cargo.toml for the benchmark crate with empty workspace
RUN printf '[package]\nname = "sort-bench"\nversion = "0.1.0"\nedition = "2021"\n\n[workspace]\n\n[dependencies]\nuu_sort = { path = "../src/uu/sort" }\nuucore = { path = "../src/uucore" }\ncriterion = "0.5"\ntempfile = "3"\nclap = { version = "4.4", features = ["wrap_help", "cargo"] }\nrand = "0.8"\n\n[[bench]]\nname = "sort_bench"\nharness = false\n' > Cargo.toml

# Copy the benchmark source
COPY benches/sort_bench.rs benches/sort_bench.rs

# Build benchmark without running
RUN cargo bench --no-run

# Run Rust sort benchmark and save results (save both stdout and stderr)
RUN cargo bench 2>&1 | tee /tmp/rust_sort_bench.txt || echo "Rust benchmark failed with exit code $?" | tee -a /tmp/rust_sort_bench.txt


# ===============================
# Stage 2: Build GNU coreutils 
# ===============================
FROM ubuntu:22.04 AS gnu-build

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    wget build-essential cmake automake autoconf \
    gettext autopoint bison git gperf texinfo rsync \
    libbenchmark-dev vim nano strace \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src
RUN git clone https://git.savannah.gnu.org/git/gnulib.git
RUN git clone https://git.savannah.gnu.org/git/coreutils.git && \
    cd coreutils && \
    git checkout 445f502839b6b13d051612e989a02a36f8b9176e

WORKDIR /usr/src/coreutils
RUN ./bootstrap
RUN FORCE_UNSAFE_CONFIGURE=1 ./configure

# Build coreutils once to generate config.h and all dependencies
RUN make -j$(nproc)

# Extract the actual compilation flags used
RUN cd src && make sort.o V=1 2>&1 | tee /tmp/compile_flags.txt || true

# Now copy modified sort.c
COPY sort.c /usr/src/coreutils/src/sort.c

# Rebuild sort.o manually with proper flags
RUN cd src && \
    gcc -DHAVE_CONFIG_H \
    -I. -I.. -I../lib -I../lib \
    -DLOCALEDIR=\"/usr/local/share/locale\" \
    -g -O2 -c sort.c -o sort.o

RUN cd src && gcc -DHAVE_CONFIG_H \
    -I. -I.. -I../lib -I../lib \
    -g -O2 -c version.c -o version.o

# Copy benchmark
COPY sort_benchmark.cpp /usr/src/

# Compile benchmark and link with sort.o and all coreutils dependencies
WORKDIR /usr/src
RUN g++ -std=c++11 -O3 sort_benchmark.cpp \
    /usr/src/coreutils/src/sort.o \
    /usr/src/coreutils/src/version.o \
    /usr/src/coreutils/lib/libcoreutils.a \
    -o gnu_sort_benchmark \
    -Wl,--whole-archive -lbenchmark -Wl,--no-whole-archive -lpthread \
    -I/usr/src/coreutils \
    -I/usr/src/coreutils/src \
    -I/usr/src/coreutils/lib

RUN ./gnu_sort_benchmark --benchmark_format=console 2>&1 | tee /tmp/gnu_sort_bench.txt || echo "GNU benchmark failed" | tee -a /tmp/gnu_sort_bench.txt

# ===============================
# Stage 3: Combine results
# ===============================
FROM ubuntu:22.04

WORKDIR /results
COPY --from=rust-build /tmp/rust_sort_bench.txt rust_sort_bench.txt
COPY --from=gnu-build /tmp/gnu_sort_bench.txt gnu_sort_bench.txt

RUN echo "=== RUST SORT BENCHMARK ===" > bench_results.txt && \
    cat rust_sort_bench.txt >> bench_results.txt && \
    echo "" >> bench_results.txt && \
    echo "=== GNU SORT BENCHMARK ===" >> bench_results.txt && \
    cat gnu_sort_bench.txt >> bench_results.txt

CMD ["cat", "/results/bench_results.txt"]