use criterion::{criterion_group, criterion_main, Criterion};
use std::ffi::OsString;
use std::fs::File;
use std::io::Write;
use tempfile::tempdir;
use uu_split::uumain;


fn generate_test_file(size_mb: usize) -> std::path::PathBuf {
    let dir = tempdir().unwrap();
    let path = dir.path().join("input.bin");
    let mut file = File::create(&path).unwrap();
    let chunk = vec![b'A'; 1024 * 1024];
    for _ in 0..size_mb {
        file.write_all(&chunk).unwrap();
    }
    path
}

fn bench_rust_split(c: &mut Criterion) {
    let input_file = generate_test_file(100);
    c.bench_function("rust coreutils split 10MB", |b| {
        b.iter(|| {
            let output_prefix = tempdir().unwrap().path().join("x_");
            let args: Vec<OsString> = vec![
                "split".into(),
                "-b".into(),
                "10M".into(),
                input_file.as_os_str().into(),
                output_prefix.as_os_str().into(),
            ];
            let _ = uumain(args.into_iter());
        })
    });
}

criterion_group!(benches, bench_rust_split);
criterion_main!(benches);