use criterion::{criterion_group, criterion_main, Criterion, BenchmarkId, Throughput};
use std::ffi::OsString;
use std::fs::File;
use std::io::Write;
use tempfile::TempDir;
use uu_split::uumain;

fn generate_test_file(size: usize) -> (TempDir, std::path::PathBuf) {
    let dir = TempDir::new().unwrap();
    let path = dir.path().join("input.txt");
    let mut file = File::create(&path).unwrap();
    
    let line = b"test line\n";
    let mut written = 0;
    while written < size {
        let to_write = std::cmp::min(line.len(), size - written);
        file.write_all(&line[..to_write]).unwrap();
        written += to_write;
    }
    
    (dir, path)
}

fn bench_split_lines(c: &mut Criterion) {
    let mut group = c.benchmark_group("split_lines");
    
    let params = [
        (1 << 20, 100),      // 1MB file, 100 lines per file
        (1 << 22, 1000),     // 4MB file, 1000 lines per file
        (1 << 24, 10000),    // 16MB file, 10000 lines per file
    ];
    
    for (file_size, lines_per_file) in params.iter() {
        group.throughput(Throughput::Bytes(*file_size as u64));
        group.bench_with_input(
            BenchmarkId::from_parameter(format!("{}MB/{}lines", file_size >> 20, lines_per_file)),
            &(*file_size, *lines_per_file),
            |b, &(size, lines)| {
                let (_dir, input_file) = generate_test_file(size);
                b.iter(|| {
                    let output_dir = TempDir::new().unwrap();
                    let output_prefix = output_dir.path().join("split_out_");
                    let args: Vec<OsString> = vec![
                        "split".into(),
                        "-l".into(),
                        lines.to_string().into(),
                        input_file.as_os_str().into(),
                        output_prefix.as_os_str().into(),
                    ];
                    let _ = uumain(args.into_iter());
                });
            },
        );
    }
    
    group.finish();
}

fn bench_split_bytes(c: &mut Criterion) {
    let mut group = c.benchmark_group("split_bytes");
    
    let params = [
        (1 << 20, 1 << 14),   // 1MB file, 16KB per file
        (1 << 22, 1 << 16),   // 4MB file, 64KB per file
        (1 << 24, 1 << 18),   // 16MB file, 256KB per file
    ];
    
    for (file_size, bytes_per_file) in params.iter() {
        group.throughput(Throughput::Bytes(*file_size as u64));
        group.bench_with_input(
            BenchmarkId::from_parameter(format!("{}MB/{}KB", file_size >> 20, bytes_per_file >> 10)),
            &(*file_size, *bytes_per_file),
            |b, &(size, bytes)| {
                let (_dir, input_file) = generate_test_file(size);
                b.iter(|| {
                    let output_dir = TempDir::new().unwrap();
                    let output_prefix = output_dir.path().join("split_out_");
                    let args: Vec<OsString> = vec![
                        "split".into(),
                        "-b".into(),
                        bytes.to_string().into(),
                        input_file.as_os_str().into(),
                        output_prefix.as_os_str().into(),
                    ];
                    let _ = uumain(args.into_iter());
                });
            },
        );
    }
    
    group.finish();
}

fn bench_split_line_bytes(c: &mut Criterion) {
    let mut group = c.benchmark_group("split_line_bytes");
    
    let params = [
        (1 << 20, 1 << 14),   // 1MB file, 16KB per file
        (1 << 22, 1 << 16),   // 4MB file, 64KB per file
        (1 << 24, 1 << 18),   // 16MB file, 256KB per file
    ];
    
    for (file_size, bytes_per_file) in params.iter() {
        group.throughput(Throughput::Bytes(*file_size as u64));
        group.bench_with_input(
            BenchmarkId::from_parameter(format!("{}MB/{}KB", file_size >> 20, bytes_per_file >> 10)),
            &(*file_size, *bytes_per_file),
            |b, &(size, bytes)| {
                let (_dir, input_file) = generate_test_file(size);
                b.iter(|| {
                    let output_dir = TempDir::new().unwrap();
                    let output_prefix = output_dir.path().join("split_out_");
                    let args: Vec<OsString> = vec![
                        "split".into(),
                        "-C".into(),
                        bytes.to_string().into(),
                        input_file.as_os_str().into(),
                        output_prefix.as_os_str().into(),
                    ];
                    let _ = uumain(args.into_iter());
                });
            },
        );
    }
    
    group.finish();
}

fn bench_split_chunks(c: &mut Criterion) {
    let mut group = c.benchmark_group("split_chunks");
    
    let params = [
        (1 << 20, 5),        // 1MB file, 5 chunks
        (1 << 22, 10),       // 4MB file, 10 chunks
        (1 << 24, 20),       // 16MB file, 20 chunks
    ];
    
    for (file_size, num_chunks) in params.iter() {
        group.throughput(Throughput::Bytes(*file_size as u64));
        group.bench_with_input(
            BenchmarkId::from_parameter(format!("{}MB/{}chunks", file_size >> 20, num_chunks)),
            &(*file_size, *num_chunks),
            |b, &(size, chunks)| {
                let (_dir, input_file) = generate_test_file(size);
                b.iter(|| {
                    let output_dir = TempDir::new().unwrap();
                    let output_prefix = output_dir.path().join("split_out_");
                    let args: Vec<OsString> = vec![
                        "split".into(),
                        "-n".into(),
                        chunks.to_string().into(),
                        input_file.as_os_str().into(),
                        output_prefix.as_os_str().into(),
                    ];
                    let _ = uumain(args.into_iter());
                });
            },
        );
    }
    
    group.finish();
}

fn bench_split_round_robin(c: &mut Criterion) {
    let mut group = c.benchmark_group("split_round_robin");
    
    let params = [
        (1 << 20, 3),        // 1MB file, 3 files
        (1 << 22, 5),        // 4MB file, 5 files
        (1 << 24, 8),        // 16MB file, 8 files
    ];
    
    for (file_size, num_files) in params.iter() {
        group.throughput(Throughput::Bytes(*file_size as u64));
        group.bench_with_input(
            BenchmarkId::from_parameter(format!("{}MB/{}files", file_size >> 20, num_files)),
            &(*file_size, *num_files),
            |b, &(size, files)| {
                let (_dir, input_file) = generate_test_file(size);
                b.iter(|| {
                    let output_dir = TempDir::new().unwrap();
                    let output_prefix = output_dir.path().join("split_out_");
                    let args: Vec<OsString> = vec![
                        "split".into(),
                        "-n".into(),
                        format!("r/{}", files).into(),
                        input_file.as_os_str().into(),
                        output_prefix.as_os_str().into(),
                    ];
                    let _ = uumain(args.into_iter());
                });
            },
        );
    }
    
    group.finish();
}

criterion_group!(
    benches,
    bench_split_lines,
    bench_split_bytes,
    bench_split_line_bytes,
    bench_split_chunks,
    bench_split_round_robin
);
criterion_main!(benches);