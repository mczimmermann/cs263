# ===============================
# Stage 1: Build Rust uutils coreutils (split)
# ===============================
FROM rust:latest AS rust-build

RUN apt-get update && apt-get install -y \
    git cmake build-essential wget libbenchmark-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src

# Clone the Rust coreutils repository
RUN git clone https://github.com/uutils/coreutils.git
WORKDIR /usr/src/coreutils

# Create a standalone benchmark crate
RUN mkdir -p split-bench/src split-bench/benches
WORKDIR /usr/src/coreutils/split-bench

# Create minimal lib file
RUN echo "// placeholder lib file\npub fn dummy() {}" > src/lib.rs

# Create Cargo.toml for the benchmark crate with empty workspace
RUN printf '[package]\nname = "split-bench"\nversion = "0.1.0"\nedition = "2021"\n\n[workspace]\n\n[dependencies]\nuu_split = { path = "../src/uu/split" }\nuucore = { path = "../src/uucore" }\ncriterion = "0.5"\ntempfile = "3"\nclap = { version = "4.4", features = ["wrap_help", "cargo"] }\n\n[[bench]]\nname = "split_bench"\nharness = false\n' > Cargo.toml

# Copy the benchmark source
COPY benches/split_bench.rs benches/split_bench.rs

# Build benchmark without running
RUN cargo bench --no-run

# Run Rust split benchmark and save results (save both stdout and stderr)
RUN cargo bench 2>&1 | tee /tmp/rust_split_bench.txt || echo "Rust benchmark failed with exit code $?" | tee -a /tmp/rust_split_bench.txt


# ===============================
# Stage 2: Build GNU coreutils (from tar.gz)
# ===============================
FROM ubuntu:22.04 AS gnu-build

RUN apt-get update && apt-get install -y \
    wget build-essential libbenchmark-dev cmake automake autoconf gettext \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src

RUN wget https://ftp.gnu.org/gnu/coreutils/coreutils-9.2.tar.gz && \
    tar -xzf coreutils-9.2.tar.gz && \
    mv coreutils-9.2 coreutils

WORKDIR /usr/src/coreutils
RUN FORCE_UNSAFE_CONFIGURE=1 ./configure && make -j$(nproc)

WORKDIR /usr/src/gnu_split_bench
COPY gnu_split_bench.cpp gnu_split_bench.cpp
RUN g++ -O2 -std=c++17 gnu_split_bench.cpp -lbenchmark -lpthread -o gnu_split_bench

RUN ./gnu_split_bench --benchmark_format=console 2>&1 | tee /tmp/gnu_split_bench.txt || echo "GNU benchmark failed" | tee -a /tmp/gnu_split_bench.txt


# ===============================
# Stage 3: Combine results
# ===============================
FROM ubuntu:22.04

WORKDIR /results
COPY --from=rust-build /tmp/rust_split_bench.txt rust_split_bench.txt
COPY --from=gnu-build /tmp/gnu_split_bench.txt gnu_split_bench.txt

RUN echo "=== RUST SPLIT BENCHMARK ===" > bench_results.txt && \
    cat rust_split_bench.txt >> bench_results.txt && \
    echo "" >> bench_results.txt && \
    echo "=== GNU SPLIT BENCHMARK ===" >> bench_results.txt && \
    cat gnu_split_bench.txt >> bench_results.txt

CMD ["cat", "/results/bench_results.txt"]